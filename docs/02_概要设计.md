# PDF文本提取后台服务 - 概要设计文档

**文档版本**: v1.0
**编写日期**: 2026年1月20日
**项目名称**: PDF文本提取与本体论分析后台服务

---

## 1. 设计概述

### 1.1 设计目标

构建一个基于Django + DRF的RESTful API服务，集成MinerU和Step5算法，实现PDF文档的自动化文本提取和本体论驱动的信息抽取。系统采用异步任务队列处理长时间运行任务，支持水平扩展和容器化部署。

### 1.2 设计原则

- **模块化**: 项目管理、文件管理、任务处理等功能模块独立
- **可扩展**: 支持Celery Worker水平扩展，支持Kubernetes部署
- **简洁性**: 采用同步编程模式，避免过度设计
- **标准化**: 遵循RESTful API设计规范，统一响应格式
- **可维护性**: 清晰的代码结构，完整的文档和注释

---

## 2. 系统架构

### 2.1 总体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                            外部用户/系统                              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          Nginx 反向代理                              │
│                      (auth_request 认证)                             │
│                  添加 X-User-ID Header                               │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Django REST API 服务                          │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  API层: DRF ViewSets / APIViews                              │  │
│  │  - ProjectViewSet (项目CRUD)                                 │  │
│  │  - FileUploadView (文件上传)                                 │  │
│  │  - FileListView (文件列表)                                   │  │
│  │  - FileContentView (内容查询)                                │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                             ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  业务逻辑层: Services                                         │  │
│  │  - MinerUService (调用MinerU API)                            │  │
│  │  - OntologyService (本体论提取)                              │  │
│  │  - FileStorageService (文件存储)                             │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                             ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  数据访问层: Django ORM Models                                │  │
│  │  - User, Project, File                                        │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
└────────────────────────────┼────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         PostgreSQL 数据库                            │
└─────────────────────────────────────────────────────────────────────┘

                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Celery 异步任务队列                             │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  RabbitMQ Broker (消息队列)                                   │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                             ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Celery Worker (任务执行器)                                   │  │
│  │  - process_pdf_task()                                         │  │
│  │    1. 调用 MinerU Web API                                     │  │
│  │    2. 调用 Step5 OntologyAgent                                │  │
│  │    3. 更新数据库状态                                          │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                             ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Redis Result Backend (结果存储)                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     外部服务集成                                     │
│  ┌────────────────────┐         ┌───────────────────────────────┐   │
│  │  MinerU Web Service│ <──────>│  共享存储 (media/)            │   │
│  │  (官方Docker镜像)  │         │  - pdf/                       │   │
│  │                    │         │  - mineru/                    │   │
│  │  PDF → Markdown    │         │  - extraction/                │   │
│  └────────────────────┘         │  - ontology/                  │   │
│                                  └───────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 架构说明

#### 2.2.1 三层架构

- **表现层**: Django REST Framework提供RESTful API
- **业务逻辑层**: Services封装业务逻辑，调用外部服务
- **数据访问层**: Django ORM管理数据库操作

#### 2.2.2 异步处理架构

- **消息队列**: RabbitMQ作为任务分发中心
- **任务执行**: Celery Worker异步执行PDF处理任务
- **结果存储**: Redis存储任务执行结果和状态

#### 2.2.3 文件处理流程

1. 用户上传PDF → Django API保存文件 → 创建数据库记录
2. 触发Celery任务 → Worker调用MinerU API → 提取Markdown
3. Worker调用Step5 → 提取本体论JSON → 更新数据库
4. 用户查询API → Django读取文件内容 → 返回结果

---

## 3. 技术栈选型

### 3.1 后端框架

| 组件                 | 技术选型              | 版本  | 说明                     |
| -------------------- | --------------------- | ----- | ------------------------ |
| **Web框架**    | Django                | 4.2+  | 稳定的Web框架，强大的ORM |
| **API框架**    | Django REST Framework | 3.14+ | RESTful API构建          |
| **API文档**    | drf-spectacular       | 0.26+ | OpenAPI 3.0文档生成      |
| **异步任务**   | Celery                | 5.3+  | 分布式任务队列           |
| **消息队列**   | RabbitMQ              | 3.12+ | 可靠的消息中间件         |
| **结果后端**   | Redis                 | 7.0+  | 高性能缓存和结果存储     |
| **数据库**     | PostgreSQL            | 14+   | 企业级关系数据库         |
| **数据库驱动** | psycopg2-binary       | 2.9+  | PostgreSQL Python适配器  |

### 3.2 外部服务

| 组件                 | 技术选型            | 说明                             |
| -------------------- | ------------------- | -------------------------------- |
| **PDF解析**    | MinerU Web Service  | 官方Docker镜像，通过HTTP API调用 |
| **本体论提取** | Step5 OntologyAgent | 基于现有代码封装为Service模块    |
| **LLM服务**    | DeepSeek API        | Step5依赖，用于本体论提取        |

### 3.3 部署工具

| 组件               | 技术选型       | 说明              |
| ------------------ | -------------- | ----------------- |
| **容器化**   | Docker         | 应用容器化        |
| **开发环境** | Docker Compose | 本地开发环境编排  |
| **生产环境** | Kubernetes     | 容器编排和管理    |
| **配置管理** | Helm           | k8s应用打包和部署 |

### 3.4 开发工具

| 组件               | 技术选型          | 说明             |
| ------------------ | ----------------- | ---------------- |
| **环境管理** | python-dotenv     | 环境变量配置     |
| **数据迁移** | Django Migrations | 数据库版本管理   |
| **代码规范** | ruff              | 代码格式化和检查 |

---

## 4. 模块划分

### 4.1 Django应用结构

```

backend/                          # 项目根目录
├── manage.py                     # Django管理脚本
├── requirements.txt              # Python依赖
├── .env.example                  # 环境变量示例
├── backend/                      # 项目配置目录
│   ├── __init__.py
│   ├── settings.py              # 环境配置
│   ├── urls.py                  # 主路由配置
│   ├── celery.py                # Celery配置
│   └── wsgi.py                  # WSGI入口
|—— text_extraction/             # 文本抽取APP, django startapp 生成
│   ├── __init__.py
│   ├── admin.py
│   ├── models.py
│   ├── serializers.py
│   ├── views.py
│   ├── urls.py
│   ├── services/                # 外部服务
│       ├── mineru_service.py    # mineru
│       └── ontology_service.py  # ontology_service
│   └── tasks.py  
└── media/                       # 媒体文件目录
    ├── pdf/                     # 原始PDF
    ├── mineru/                  # MinerU输出
    ├── extraction/              # 本体论提取结果
    └── ontology/                # 项目本体论文件
```

### 4.2 核心模块说明

#### 4.2.1 文本抽取 (text_extraction)

- **职责**: 自定义django rest auth , 项目管理, 文件管理
- **核心功能**:

  - 自定义django rest framework auth 类，HeaderAuthentication（读取X-User-ID header）
  - 用户自动创建
  - ProjectViewSet（完整CRUD）
  - 软删除实现
  - 上传自定义本体论或使用默认ontology_v2.json
  - HeaderAuthentication（读取X-User-ID header）
  - FileUploadView（处理multipart上传）
  - FileListView（分页查询）
  - FileContentView（读取提取结果）
  - process_pdf_task（Celery异步任务）
