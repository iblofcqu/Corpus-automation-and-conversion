# PDF文本提取后台服务 - 需求分析文档

**文档版本**: v1.0
**编写日期**: 2026年1月20日
**项目名称**: PDF文本提取与本体论分析后台服务

---

## 1. 项目概述

### 1.1 项目背景

现有的PDF处理系统基于命令行脚本工具链（Step1-Step5），需要手动执行处理流程。为了提升易用性和自动化程度，需要构建一个完整的后台服务系统，支持：

- 项目管理和文件组织
- PDF文件上传和批量处理
- 基于MinerU的文本提取
- 基于本体论驱动的智能信息抽取
- 异步任务队列处理
- RESTful API接口调用

### 1.2 项目目标

构建一个企业级的PDF文档智能处理平台，提供完整的项目生命周期管理，支持多用户、多项目并发处理，实现从PDF上传到结构化数据提取的自动化流程。

### 1.3 应用场景

- **事故报告分析**: 批量处理事故调查报告PDF，提取结构化信息
- **文档知识库**: 将PDF文档转化为可查询的结构化知识
- **合规审查**: 基于预定义本体论自动提取关键合规信息

---

## 2. 功能需求

### 2.1 项目管理模块

#### FR-1.1 创建项目

- **功能描述**: 用户可以创建新项目，并可选上传自定义本体论JSON文件
- **输入**: 项目名称、描述（可选）、本体论文件（可选）
- **输出**: 项目ID、项目详情
- **业务规则**:
  - 项目名称不能为空
  - 如果未上传本体论文件，系统使用默认的 `ontology_v2.json`
  - 上传的本体论文件保存到 `media/ontology/{project_id}.json`
  - 自动记录创建者用户ID

#### FR-1.2 查询项目列表

- **功能描述**: 查询所有未删除的项目列表
- **输入**: 无（未来可扩展：分页、搜索关键词）
- **输出**: 项目列表（ID、名称、描述、创建时间等）
- **业务规则**:
  - 仅返回 `is_deleted=False`的项目
  - 按创建时间倒序排列

#### FR-1.3 查询项目详情

- **功能描述**: 查询指定项目的详细信息
- **输入**: 项目ID
- **输出**: 项目详细信息（包括关联的本体论路径）
- **业务规则**:
  - 项目不存在或已删除时返回404错误

#### FR-1.4 删除项目

- **功能描述**: 软删除指定项目
- **输入**: 项目ID
- **输出**: 删除成功确认
- **业务规则**:
  - 采用软删除机制，设置 `is_deleted=True`
  - 不删除物理文件（PDF、提取结果等）
  - 已删除的项目不再出现在列表中

---

### 2.2 文件管理模块

#### FR-2.1 上传PDF文件

- **功能描述**: 向指定项目上传PDF文件，自动触发处理任务
- **输入**: 项目ID、PDF文件（multipart/form-data）
- **输出**: 文件ID、任务ID、文件详情
- **业务规则**:
  - PDF文件大小限制：最大50MB
  - 文件保存到 `media/pdf/{project_id}/{uuid}_{filename}.pdf`
  - 创建文件记录，初始状态为 `pending`
  - 自动触发Celery异步处理任务
  - 返回任务ID供后续查询进度

#### FR-2.2 查询文件列表

- **功能描述**: 分页查询指定项目下的文件列表
- **输入**: 项目ID、页码（默认1）、每页数量（默认10，可自定义）
- **输出**: 文件列表（ID、文件名、状态、上传时间、处理完成时间）、总数、分页信息
- **业务规则**:
  - 按上传时间倒序排列
  - 支持自定义每页数量（page_size参数）
  - 返回文件处理状态（pending/processing/completed/failed）

#### FR-2.3 查询文件详情

- **功能描述**: 查询指定文件的详细信息
- **输入**: 文件ID
- **输出**: 文件详细信息（文件名、路径、状态、任务ID、错误信息等）
- **业务规则**:
  - 包含处理状态和错误信息（如果失败）

#### FR-2.4 查询文件提取内容

- **功能描述**: 查询已处理完成文件的提取结果
- **输入**: 文件ID
- **输出**: Markdown文本内容、本体论JSON数据
- **业务规则**:
  - 仅当文件状态为 `completed`时可查询
  - 返回MinerU提取的Markdown文本
  - 返回Step5提取的本体论结构化JSON
  - 状态非completed时返回错误提示

---

### 2.3 异步处理模块

#### FR-3.1 PDF文本提取任务

- **功能描述**: 使用MinerU Web服务提取PDF文本内容
- **输入**: 文件ID（内部调用）
- **输出**: Markdown文件、图片目录、元数据JSON
- **处理流程**:
  1. 更新文件状态为 `processing`
  2. 通过HTTP调用MinerU Web API
  3. 传递PDF文件路径，获取处理结果
  4. MinerU输出保存到 `media/mineru/{project_id}/`
  5. 更新文件记录的 `mineru_output_path`字段
  6. 成功后触发下一步本体论提取

#### FR-3.2 本体论信息提取任务

- **功能描述**: 基于Step5算法提取结构化信息
- **输入**: Markdown文件路径、项目本体论路径
- **输出**: 本体论JSON、处理记忆JSON
- **处理流程**:
  1. 读取MinerU生成的Markdown文件
  2. 加载项目的本体论定义
  3. 调用 `OntologyAgent.process_document()`
  4. 提取结构化信息（5个步骤：标题提取→拆分规划→文档拆分→信息提取→序列化）
  5. 输出保存到 `media/extraction/{project_id}/`
  6. 更新文件记录的 `extraction_output_path`字段
  7. 更新文件状态为 `completed`

#### FR-3.3 错误处理

- **功能描述**: 处理任务执行失败的情况
- **业务规则**:
  - 任务执行失败时，文件状态标记为 `failed`
  - 记录错误信息到 `error_message`字段
  - 任务超时设置为30分钟
  - 不自动重试，需要用户重新上传或手动触发（未来扩展）

---

## 3. 非功能需求

### 3.1 性能需求

- **NFR-1**: 文件上传接口响应时间 < 3秒（不包括文件传输时间）
- **NFR-2**: 文件列表查询响应时间 < 500ms
- **NFR-3**: 单个PDF处理时间预期5-10分钟（取决于文件大小和复杂度）
- **NFR-4**: 系统支持并发处理多个项目的文件（多Worker扩展）
- **NFR-5**: 单个项目同时仅处理一个PDF（保证资源利用率和处理稳定性）

### 3.2 可用性需求

- **NFR-6**: 系统可用性目标 ≥ 99%（暂不考虑高可用架构，单实例部署）
- **NFR-7**: 提供标准RESTful API接口
- **NFR-8**: 提供OpenAPI（Swagger）在线文档
- **NFR-9**: API返回统一格式：`{"status": 200, "message": "", "data": {...}}`

### 3.3 安全性需求

- **NFR-10**: 通过Nginx反向代理的 `auth_request`模块进行认证
- **NFR-11**: Nginx认证通过后，在HTTP Header中携带用户ID（X-User-ID）
- **NFR-12**: 后台服务根据Header自动创建用户（首次）或关联已有用户
- **NFR-13**: 不实现内置的用户登录、注册、权限管理功能

### 3.4 可维护性需求

- **NFR-14**: 代码遵循Django最佳实践和PEP 8规范
- **NFR-15**: 关键业务逻辑添加日志记录
- **NFR-16**: 使用Django ORM进行数据库操作
- **NFR-17**: 使用Django Migrations管理数据库版本

### 3.5 可扩展性需求

- **NFR-18**: 支持水平扩展Celery Worker节点
- **NFR-19**: 支持Kubernetes部署和自动扩缩容
- **NFR-20**: 媒体文件存储支持PVC持久化卷

---

## 4. 约束条件

### 4.1 技术约束

- **C-1**: 必须使用Python语言开发
- **C-2**: 必须使用Django框架（不使用FastAPI、Django Ninja）
- **C-3**: 必须使用Django REST Framework构建API
- **C-4**: 必须使用同步编程模式（不使用异步async/await）
- **C-5**: 必须使用PostgreSQL数据库(初期开发暂时使用sqlite, 后期转PostgreSQL)
- **C-6**: 必须使用RabbitMQ作为消息队列
- **C-7**: 必须使用Redis作为Celery结果后端
- **C-8**: 必须使用MinerU官方Web服务（不自行封装）

### 4.2 部署约束

- **C-9**: 开发环境使用Docker Compose部署
- **C-10**: 生产环境基于Kubernetes (k8s)部署
- **C-11**: 使用Helm管理k8s配置
- **C-12**: API服务和MinerU Web服务部署在同一Pod中（sidecar模式）
- **C-13**: 通过共享存储（emptyDir或PVC）交换文件

### 4.3 业务约束

- **C-14**: 项目删除采用软删除，不删除物理文件
- **C-15**: PDF文件大小限制50MB
- **C-16**: 单个项目同时只能处理一个PDF文件
- **C-17**: Celery Worker并发数设置为1
- **C-18**: 任务处理超时时间30分钟
- **C-19**: 失败任务不自动重试

### 4.4 存储约束

- **C-20**: 所有文件路径在数据库中存储为相对路径
- **C-21**: 不将文件内容存储到数据库
- **C-22**: 媒体文件不通过Django静态文件服务提供
- **C-23**: 媒体文件不通过Nginx直接提供
- **C-24**: 文件内容通过API接口读取并返回

---

## 5. 用户角色

### 5.1 系统用户

- **角色**: 通过Nginx认证的外部用户
- **权限**: 创建项目、上传文件、查询项目和文件信息
- **识别方式**: 通过HTTP Header的 `X-User-ID`字段
- **用户创建**: 首次访问时自动创建用户记录

### 5.2 系统管理员（未来扩展）

- **角色**: 系统运维人员
- **权限**: 管理所有项目和文件、查看系统日志、监控任务状态
- **访问方式**: 暂不实现Django Admin后台（未来需求再扩展）

---

## 6. 系统边界

### 6.1 包含的功能

- 项目和文件的CRUD操作
- PDF文件上传和存储
- 异步任务调度和执行
- MinerU文本提取集成
- Step5本体论信息提取
- RESTful API接口
- OpenAPI文档生成
- 用户自动创建和认证

### 6.2 不包含的功能

- 用户登录、注册、密码管理
- 用户权限管理（RBAC）
- 前端界面（仅提供API）
- 文件预览功能
- 实时任务进度推送（WebSocket）
- 文件内容搜索功能
- 文件版本管理
- 数据备份和恢复
- 系统监控和告警
- Django Admin管理后台

---

## 7. 接口需求

### 7.1 外部系统接口

#### 7.1.1 Nginx认证服务

- **接口类型**: HTTP Header传递
- **输入**: 经过Nginx `auth_request`认证后的请求
- **必需Header**: `X-User-ID`（用户唯一标识）
- **说明**: 所有API请求必须携带此Header

#### 7.1.2 MinerU Web服务

- **接口类型**: HTTP REST API
- **功能**: PDF转Markdown文本提取
- **输入**: PDF文件路径
- **输出**: Markdown文件、图片目录、元数据JSON
- **说明**: 使用MinerU官方提供的Docker镜像和API（具体接口待查阅官方文档）

### 7.2 内部模块接口

#### 7.2.1 Step5本体论提取模块

- **接口类型**: Python函数调用
- **输入**: Markdown文件路径、输出目录、本体论JSON路径
- **输出**: 本体论JSON文件、处理记忆JSON文件
- **说明**: 封装现有的 `Step5_ontology_agent_v2.py`中的 `OntologyAgent`类

---

## 8. 数据需求

### 8.1 数据实体

- **项目（Project）**: 项目元信息、本体论配置
- **文件（File）**: PDF文件记录、处理状态、结果路径
- **用户（User）**: 用户标识、创建时间

### 8.2 数据量估算

- **初期**:
  - 项目数量: < 100
  - 文件数量: < 1000
  - 用户数量: < 50
- **数据增长**: 中低速增长，预计每月新增50-100个文件

### 8.3 数据保留策略

- **项目数据**: 永久保留（软删除）
- **文件数据**: 永久保留
- **物理文件**: 永久保留（未来可扩展自动清理策略）
- **任务日志**: 保留30天（Celery结果后端）

---

## 9. 验收标准

### 9.1 功能验收

- [ ] 用户可以成功创建项目
- [ ] 用户可以上传自定义本体论JSON
- [ ] 用户可以上传PDF文件（最大50MB）
- [ ] PDF文件上传后自动触发处理任务
- [ ] 文件列表可以分页查询（10条/页）
- [ ] 可以查询文件处理状态（pending/processing/completed/failed）
- [ ] 处理完成的文件可以获取Markdown文本内容
- [ ] 处理完成的文件可以获取本体论JSON数据
- [ ] 项目可以软删除
- [ ] 任务处理失败时正确标记状态和错误信息

### 9.2 性能验收

- [ ] 文件上传接口响应时间 < 3秒
- [ ] 文件列表查询响应时间 < 500ms
- [ ] 单个PDF处理成功（5-10分钟内完成）
- [ ] 多个项目可以并发处理文件

### 9.3 文档验收

- [ ] 提供OpenAPI (Swagger)在线文档
- [ ] 接口文档包含所有API的详细说明
- [ ] 提供部署文档（Docker Compose、Kubernetes）
- [ ] 提供开发环境搭建文档

---

## 10. 风险与假设

### 10.1 技术风险

- **R-1**: MinerU Web服务稳定性未知，可能导致处理失败率较高
- **R-2**: Step5本体论提取依赖LLM（DeepSeek API），API限流或不可用会影响处理
- **R-3**: 大文件处理可能导致内存溢出
- **R-4**: Celery任务执行时间较长，可能出现超时

### 10.2 业务风险

- **R-5**: 用户上传的自定义本体论格式错误导致处理失败
- **R-6**: PDF文件格式复杂（扫描版、加密等）导致提取质量差

### 10.3 假设条件

- **A-1**: Nginx认证服务已经存在并正常工作
- **A-2**: MinerU官方Docker镜像可以正常部署和调用
- **A-3**: Kubernetes集群已搭建完成并可用
- **A-4**: 用户上传的PDF文件格式基本符合处理要求

---

## 11. 未来扩展方向

### 11.1 短期扩展（3-6个月）

- 支持文件处理失败后手动重试
- 支持查询任务实时进度（通过Celery AsyncResult）
- 支持按文件名搜索和按状态筛选
- 支持批量上传文件
- 启用Django Admin后台管理

### 11.2 长期扩展（6-12个月）

- 实现完整的用户权限管理系统
- 支持文件内容全文搜索
- 支持文件版本管理
- 支持WebSocket实时推送处理进度
- 集成企业级日志收集系统（ELK/Loki）
- 支持对象存储（S3/OSS）替代本地存储
- 支持PDF在线预览
- 支持导出处理结果为Excel/Word
