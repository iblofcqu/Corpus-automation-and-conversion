# PDF文本提取后台服务 - 部署运维文档

**文档版本**: v1.0
**编写日期**: 2026年1月20日
**项目名称**: PDF文本提取与本体论分析后台服务

---

## 1. 环境要求

### 1.1 开发环境

| 组件           | 版本要求 | 说明           |
| -------------- | -------- | -------------- |
| Python         | 3.10+    | 推荐3.10或3.11 |
| Docker         | 20.10+   | 容器运行环境   |
| Docker Compose | 2.0+     | 多容器编排     |
| Git            | 2.30+    | 版本控制       |
| VSCode         | 最新版   | 推荐IDE        |

### 1.2 生产环境

| 组件          | 版本要求 | 说明                         |
| ------------- | -------- | ---------------------------- |
| Kubernetes    | 1.24+    | 容器编排平台                 |
| Helm          | 3.10+    | K8s包管理器                  |
| Docker        | 20.10+   | 容器运行时                   |
| PostgreSQL    | 14+      | 数据库（可用云服务）         |
| RabbitMQ      | 3.12+    | 消息队列（可用云服务）       |
| Redis         | 7.0+     | 缓存和结果后端（可用云服务） |
| Nginx Ingress | 最新版   | 入口控制器                   |

---

## 2. 开发环境部署

### 2.1 项目结构

```
backend/
├── docker-compose.yml           # Docker Compose配置
├── Dockerfile                   # 应用镜像构建
├── requirements.txt             # Python依赖
├── .env.example                 # 环境变量示例
├── manage.py                    # Django管理脚本
├── backend/                     # 项目配置目录
│   ├── __init__.py
│   ├── settings.py              # 环境配置
│   ├── urls.py                  # 主路由配置
│   ├── celery.py                # Celery配置
│   └── wsgi.py                  # WSGI入口
├── text_extraction/             # 文本抽取APP
│   ├── __init__.py
│   ├── admin.py
│   ├── models.py                # User, Project, File模型
│   ├── serializers.py           # DRF序列化器
│   ├── views.py                 # API视图
│   ├── urls.py                  # 路由配置
│   ├── authentication.py        # 自定义认证（HeaderAuthentication）
│   ├── services/                # 外部服务
│   │   ├── mineru_service.py    # MinerU集成
│   │   └── ontology_service.py  # 本体论提取
│   └── tasks.py                 # Celery异步任务
└── media/                       # 媒体文件目录（挂载）
    ├── pdf/
    ├── mineru/
    ├── extraction/
    └── ontology/
        └── ontology_v2.json     # 默认本体论

```

### 2.2 Docker Compose配置

#### 2.2.1 docker-compose.yml

```yaml
version: '3.9'

services:
  # Django API服务
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdf-backend-web
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./:/app
      - ./media:/app/media
      - ./logs:/app/logs
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SETTINGS_MODULE=backend.settings.development
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/pdf_backend
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - MINERU_API_URL=http://mineru:8080
      - MINERU_TIMEOUT=300
    depends_on:
      - postgres
      - rabbitmq
      - redis
      - mineru
    networks:
      - pdf-network

  # Celery Worker服务
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdf-backend-worker
    command: celery -A backend worker -c 1 -l info
    volumes:
      - ./:/app
      - ./media:/app/media
      - ./logs:/app/logs
    environment:
      - DJANGO_SETTINGS_MODULE=backend.settings.development
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/pdf_backend
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - MINERU_API_URL=http://mineru:8080
      - MINERU_TIMEOUT=300
    depends_on:
      - postgres
      - rabbitmq
      - redis
      - mineru
    networks:
      - pdf-network

  # PostgreSQL数据库
  postgres:
    image: postgres:14-alpine
    container_name: pdf-backend-postgres
    environment:
      - POSTGRES_DB=pdf_backend
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - pdf-network

  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: pdf-backend-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"  # 管理界面
    networks:
      - pdf-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: pdf-backend-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - pdf-network

  # MinerU Web服务
  mineru:
    image: opendatalab/mineru:latest  # 官方镜像
    container_name: pdf-backend-mineru
    volumes:
      - ./media:/app/media
    ports:
      - "8080:8080"
    networks:
      - pdf-network

volumes:
  postgres_data:
  rabbitmq_data:
  redis_data:

networks:
  pdf-network:
    driver: bridge
```

#### 2.2.2 Dockerfile

```dockerfile
FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 创建媒体目录
RUN mkdir -p media/pdf media/mineru media/extraction media/ontology logs

# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV DJANGO_SETTINGS_MODULE=backend.settings.development

# 暴露端口
EXPOSE 8000

# 默认命令
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
```

#### 2.2.3 requirements.txt

```text
# Django核心
Django>=4.2,<5.0
djangorestframework>=3.14,<4.0
django-cors-headers>=4.0,<5.0

# API文档
drf-spectacular>=0.26,<1.0

# 数据库
psycopg2-binary>=2.9,<3.0

# 异步任务
celery>=5.3,<6.0
redis>=4.5,<5.0

# HTTP客户端
requests>=2.31,<3.0

# 环境配置
python-decouple>=3.8,<4.0

# 日志
loguru>=0.7,<1.0

# MinerU和Step5依赖
openai>=1.0.0
mineru[all]==2.7.1

# 工具
python-dateutil>=2.8,<3.0
```

### 2.3 启动步骤

#### 2.3.1 初始化项目

```bash
# 1. 克隆项目
git clone <repository-url>
cd backend

# 2. 复制环境变量配置
cp .env.example .env

# 3. 编辑.env文件，配置必要参数
# 特别是DeepSeek API Key（Step5需要）
nano .env

# 4. 复制默认本体论文件
cp ../ontology_v2.json media/ontology/ontology_v2.json
```

#### 2.3.2 启动服务

```bash
# 1. 构建并启动所有容器
docker-compose up -d

# 2. 查看容器状态
docker-compose ps

# 3. 查看日志
docker-compose logs -f web
docker-compose logs -f worker
```

#### 2.3.3 数据库初始化

```bash
# 1. 执行数据库迁移
docker-compose exec web python manage.py makemigrations
docker-compose exec web python manage.py migrate

# 2. 创建超级用户（如果需要Admin）
docker-compose exec web python manage.py createsuperuser
```

#### 2.3.4 验证服务

```bash
# 1. 访问API文档
http://localhost:8000/api/docs/

# 2. 访问RabbitMQ管理界面
http://localhost:15672/
# 用户名: guest, 密码: guest

# 3. 测试API（需要添加X-User-ID header）
curl -X GET http://localhost:8000/api/v1/projects/ \
  -H "X-User-ID: test-user"
```

### 2.4 常用命令

```bash
# 停止所有服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v

# 重启特定服务
docker-compose restart web
docker-compose restart worker

# 查看Worker日志
docker-compose logs -f worker

# 进入容器shell
docker-compose exec web bash

# 执行Django命令
docker-compose exec web python manage.py <command>

# 清理Celery任务
docker-compose exec worker celery -A backend purge
```

---

## 3. 生产环境部署 (Kubernetes)

### 3.1 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    Kubernetes 集群                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Ingress (Nginx)                                         │  │
│  │  - 域名: api.example.com                                 │  │
│  │  - TLS证书                                               │  │
│  │  - auth_request认证                                      │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                         │
│                       ▼                                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Service: api-service                                    │  │
│  │  - Type: ClusterIP                                       │  │
│  │  - Port: 8000                                            │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                         │
│                       ▼                                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Deployment: api-deployment                              │  │
│  │  - Replicas: 2                                           │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │  Pod: api-pod-1                                    │  │  │
│  │  │  ┌──────────────┐  ┌──────────────────────────┐   │  │  │
│  │  │  │ Django容器   │  │ MinerU Sidecar容器       │   │  │  │
│  │  │  │ Port: 8000   │  │ Port: 8080               │   │  │  │
│  │  │  └──────────────┘  └──────────────────────────┘   │  │  │
│  │  │  共享: emptyDir + PVC (media)                      │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │  Pod: api-pod-2                                    │  │  │
│  │  │  (同上)                                            │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Deployment: worker-deployment                           │  │
│  │  - Replicas: 1 (可扩展)                                  │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │  Pod: worker-pod-1                                 │  │  │
│  │  │  ┌──────────────────────────────────────────────┐  │  │  │
│  │  │  │ Celery Worker容器                            │  │  │  │
│  │  │  │ - 并发: 1                                    │  │  │  │
│  │  │  │ - 挂载: PVC (media)                          │  │  │  │
│  │  │  └──────────────────────────────────────────────┘  │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Job: migration-job                                      │  │
│  │  - Hook: pre-install, pre-upgrade                        │  │
│  │  - 命令: python manage.py migrate                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  PVC: media-pvc                                          │  │
│  │  - 访问模式: ReadWriteMany                               │  │
│  │  - 容量: 100Gi                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ConfigMap: app-config                                   │  │
│  │  - 环境变量配置                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Secret: app-secrets                                     │  │
│  │  - 数据库密码、API密钥等                                  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Helm Chart结构

```
k8s/helm/pdf-backend/
├── Chart.yaml                   # Chart元信息
├── values.yaml                  # 默认配置
├── values-prod.yaml             # 生产环境配置
├── templates/
│   ├── _helpers.tpl             # 模板助手
│   ├── configmap.yaml           # ConfigMap
│   ├── secret.yaml              # Secret
│   ├── pvc.yaml                 # PersistentVolumeClaim
│   ├── deployment-api.yaml      # API Deployment
│   ├── deployment-worker.yaml   # Worker Deployment
│   ├── service-api.yaml         # API Service
│   ├── ingress.yaml             # Ingress
│   ├── job-migration.yaml       # 数据库迁移Job
│   └── hpa.yaml                 # HorizontalPodAutoscaler(可选)
└── README.md
```

### 3.3 Helm配置文件

#### 3.3.1 Chart.yaml

```yaml
apiVersion: v2
name: pdf-backend
description: PDF文本提取与本体论分析后台服务
type: application
version: 1.0.0
appVersion: "1.0.0"
keywords:
  - pdf
  - extraction
  - django
  - celery
maintainers:
  - name: Team
    email: team@example.com
```

#### 3.3.2 values.yaml

```yaml
# 全局配置
global:
  storageClass: "nfs-client"  # 或 ceph-rbd, 根据实际环境

# 镜像配置
image:
  repository: your-registry.com/pdf-backend
  tag: "1.0.0"
  pullPolicy: IfNotPresent
  pullSecrets: []

mineruImage:
  repository: opendatalab/mineru
  tag: "latest"
  pullPolicy: IfNotPresent

# API服务配置
api:
  replicaCount: 2
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  livenessProbe:
    httpGet:
      path: /api/v1/projects/
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
  readinessProbe:
    httpGet:
      path: /api/v1/projects/
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5

# Worker服务配置
worker:
  replicaCount: 1
  concurrency: 1
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 8Gi

# Service配置
service:
  type: ClusterIP
  port: 8000

# Ingress配置
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/auth-url: "http://auth-service/verify"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-User-ID"
  hosts:
    - host: api.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: pdf-backend-tls
      hosts:
        - api.example.com

# 持久化存储配置
persistence:
  enabled: true
  storageClass: "nfs-client"
  accessMode: ReadWriteMany
  size: 100Gi
  mountPath: /app/media

# 环境变量配置
env:
  djangoSettingsModule: "backend.settings.production"
  mineruApiUrl: "http://localhost:8080"
  mineruTimeout: "300"

# Secret配置（需要手动创建或使用外部Secret）
secrets:
  databaseUrl: ""  # 从外部Secret注入
  celeryBrokerUrl: ""
  celeryResultBackend: ""
  deepseekApiKey: ""

# 数据库迁移Job配置
migration:
  enabled: true
  hookWeight: "-5"

# 外部服务（可选，如果使用云服务）
externalDatabase:
  enabled: false
  host: ""
  port: 5432
  database: pdf_backend
  username: postgres
  passwordSecretName: db-secret
  passwordSecretKey: password

externalRabbitmq:
  enabled: false
  host: ""
  port: 5672
  username: guest
  passwordSecretName: rabbitmq-secret
  passwordSecretKey: password

externalRedis:
  enabled: false
  host: ""
  port: 6379
  passwordSecretName: redis-secret
  passwordSecretKey: password
```

#### 3.3.3 deployment-api.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "pdf-backend.fullname" . }}-api
  labels:
    {{- include "pdf-backend.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  replicas: {{ .Values.api.replicaCount }}
  selector:
    matchLabels:
      {{- include "pdf-backend.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
  template:
    metadata:
      labels:
        {{- include "pdf-backend.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: api
    spec:
      {{- with .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        # Django容器
        - name: django
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["gunicorn"]
          args:
            - "backend.wsgi:application"
            - "--bind=0.0.0.0:8000"
            - "--workers=4"
            - "--timeout=300"
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          envFrom:
            - configMapRef:
                name: {{ include "pdf-backend.fullname" . }}-config
            - secretRef:
                name: {{ include "pdf-backend.fullname" . }}-secret
          volumeMounts:
            - name: media
              mountPath: {{ .Values.persistence.mountPath }}
            - name: shared
              mountPath: /shared
          resources:
            {{- toYaml .Values.api.resources | nindent 12 }}
          livenessProbe:
            {{- toYaml .Values.api.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml .Values.api.readinessProbe | nindent 12 }}

        # MinerU Sidecar容器
        - name: mineru
          image: "{{ .Values.mineruImage.repository }}:{{ .Values.mineruImage.tag }}"
          imagePullPolicy: {{ .Values.mineruImage.pullPolicy }}
          ports:
            - name: mineru
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: media
              mountPath: /app/media
            - name: shared
              mountPath: /shared
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 4Gi

      volumes:
        - name: media
          persistentVolumeClaim:
            claimName: {{ include "pdf-backend.fullname" . }}-media
        - name: shared
          emptyDir: {}
```

#### 3.3.4 deployment-worker.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "pdf-backend.fullname" . }}-worker
  labels:
    {{- include "pdf-backend.labels" . | nindent 4 }}
    app.kubernetes.io/component: worker
spec:
  replicas: {{ .Values.worker.replicaCount }}
  selector:
    matchLabels:
      {{- include "pdf-backend.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: worker
  template:
    metadata:
      labels:
        {{- include "pdf-backend.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: worker
    spec:
      {{- with .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: celery-worker
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["celery"]
          args:
            - "-A"
            - "backend"
            - "worker"
            - "-c"
            - "{{ .Values.worker.concurrency }}"
            - "-l"
            - "info"
          envFrom:
            - configMapRef:
                name: {{ include "pdf-backend.fullname" . }}-config
            - secretRef:
                name: {{ include "pdf-backend.fullname" . }}-secret
          volumeMounts:
            - name: media
              mountPath: {{ .Values.persistence.mountPath }}
          resources:
            {{- toYaml .Values.worker.resources | nindent 12 }}

      volumes:
        - name: media
          persistentVolumeClaim:
            claimName: {{ include "pdf-backend.fullname" . }}-media
```

#### 3.3.5 job-migration.yaml

```yaml
{{- if .Values.migration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "pdf-backend.fullname" . }}-migration
  labels:
    {{- include "pdf-backend.labels" . | nindent 4 }}
    app.kubernetes.io/component: migration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "{{ .Values.migration.hookWeight }}"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "pdf-backend.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      restartPolicy: Never
      {{- with .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: migrate
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python"]
          args:
            - "manage.py"
            - "migrate"
            - "--noinput"
          envFrom:
            - configMapRef:
                name: {{ include "pdf-backend.fullname" . }}-config
            - secretRef:
                name: {{ include "pdf-backend.fullname" . }}-secret
{{- end }}
```

#### 3.3.6 pvc.yaml

```yaml
{{- if .Values.persistence.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "pdf-backend.fullname" . }}-media
  labels:
    {{- include "pdf-backend.labels" . | nindent 4 }}
spec:
  accessModes:
    - {{ .Values.persistence.accessMode }}
  storageClassName: {{ .Values.persistence.storageClass }}
  resources:
    requests:
      storage: {{ .Values.persistence.size }}
{{- end }}
```

### 3.4 部署步骤

#### 3.4.1 准备工作

```bash
# 1. 构建Docker镜像
docker build -t your-registry.com/pdf-backend:1.0.0 .

# 2. 推送到镜像仓库
docker push your-registry.com/pdf-backend:1.0.0

# 3. 创建命名空间
kubectl create namespace pdf-backend

# 4. 创建Secret（敏感信息）
kubectl create secret generic pdf-backend-secret \
  --from-literal=DATABASE_URL='postgresql://user:pass@host:5432/db' \
  --from-literal=CELERY_BROKER_URL='amqp://user:pass@host:5672//' \
  --from-literal=CELERY_RESULT_BACKEND='redis://:pass@host:6379/0' \
  --from-literal=DEEPSEEK_API_KEY='your-api-key' \
  -n pdf-backend
```

#### 3.4.2 Helm部署

```bash
# 1. 添加依赖（如果有）
helm dependency update k8s/helm/pdf-backend/

# 2. 验证Chart
helm lint k8s/helm/pdf-backend/

# 3. 生成Kubernetes YAML（检查）
helm template pdf-backend k8s/helm/pdf-backend/ \
  -f k8s/helm/pdf-backend/values-prod.yaml \
  -n pdf-backend

# 4. 安装Chart
helm install pdf-backend k8s/helm/pdf-backend/ \
  -f k8s/helm/pdf-backend/values-prod.yaml \
  -n pdf-backend

# 5. 查看部署状态
helm status pdf-backend -n pdf-backend
kubectl get pods -n pdf-backend -w

# 6. 查看日志
kubectl logs -f deployment/pdf-backend-api -n pdf-backend -c django
kubectl logs -f deployment/pdf-backend-worker -n pdf-backend
```

#### 3.4.3 升级部署

```bash
# 1. 更新镜像
docker build -t your-registry.com/pdf-backend:1.0.1 .
docker push your-registry.com/pdf-backend:1.0.1

# 2. 升级Helm Release
helm upgrade pdf-backend k8s/helm/pdf-backend/ \
  -f k8s/helm/pdf-backend/values-prod.yaml \
  --set image.tag=1.0.1 \
  -n pdf-backend

# 3. 回滚（如果需要）
helm rollback pdf-backend -n pdf-backend
```

#### 3.4.4 卸载

```bash
# 1. 卸载Helm Release
helm uninstall pdf-backend -n pdf-backend

# 2. 删除PVC（如果需要）
kubectl delete pvc pdf-backend-media -n pdf-backend

# 3. 删除命名空间
kubectl delete namespace pdf-backend
```

---

## 4. 配置管理

### 4.1 环境变量配置

#### 4.1.1 .env文件（开发环境）

```bash
# Django配置
DJANGO_SETTINGS_MODULE=backend.settings.development
SECRET_KEY=your-secret-key-change-in-production
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# 数据库配置
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/pdf_backend

# Celery配置
CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
CELERY_RESULT_BACKEND=redis://redis:6379/0

# MinerU配置
MINERU_API_URL=http://mineru:8080
MINERU_TIMEOUT=300

# DeepSeek API配置（Step5需要）
DEEPSEEK_API_KEY=your-deepseek-api-key
DEEPSEEK_API_BASE=https://api.deepseek.com/v1

# 文件上传配置
MAX_UPLOAD_SIZE=52428800  # 50MB

# 日志配置
LOG_LEVEL=INFO
```

#### 4.1.2 ConfigMap（生产环境）

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: pdf-backend-config
  namespace: pdf-backend
data:
  DJANGO_SETTINGS_MODULE: "backend.settings.production"
  DEBUG: "False"
  ALLOWED_HOSTS: "api.example.com"
  MINERU_API_URL: "http://localhost:8080"
  MINERU_TIMEOUT: "300"
  MAX_UPLOAD_SIZE: "52428800"
  LOG_LEVEL: "INFO"
```

#### 4.1.3 Secret（生产环境）

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: pdf-backend-secret
  namespace: pdf-backend
type: Opaque
stringData:
  SECRET_KEY: "production-secret-key-change-me"
  DATABASE_URL: "postgresql://user:password@postgres-host:5432/pdf_backend"
  CELERY_BROKER_URL: "amqp://user:password@rabbitmq-host:5672//"
  CELERY_RESULT_BACKEND: "redis://:password@redis-host:6379/0"
  DEEPSEEK_API_KEY: "your-deepseek-api-key"
```

---

## 5. 运维管理

### 5.1 日志管理

#### 5.1.1 查看日志

```bash
# Docker Compose环境
docker-compose logs -f web
docker-compose logs -f worker

# Kubernetes环境
kubectl logs -f deployment/pdf-backend-api -c django -n pdf-backend
kubectl logs -f deployment/pdf-backend-worker -n pdf-backend

# 查看最近100行
kubectl logs --tail=100 deployment/pdf-backend-api -c django -n pdf-backend
```

#### 5.1.2 日志配置（Django）

```python
# backend/settings/base.py

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '[{levelname}] {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
        'file': {
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': '/app/logs/django.log',
            'maxBytes': 10485760,  # 10MB
            'backupCount': 5,
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console', 'file'],
        'level': 'INFO',
    },
    'loggers': {
        'django': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': False,
        },
        'apps': {
            'handlers': ['console', 'file'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}
```

### 5.2 监控

#### 5.2.1 健康检查端点

```python
# apps/common/views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from django.db import connection

class HealthCheckView(APIView):
    """健康检查端点"""
    authentication_classes = []
    permission_classes = []
  
    def get(self, request):
        # 检查数据库连接
        try:
            connection.ensure_connection()
            db_status = "ok"
        except Exception:
            db_status = "error"
      
        return Response({
            "status": "ok" if db_status == "ok" else "error",
            "database": db_status
        })

# backend/urls.py
urlpatterns = [
    path('health/', HealthCheckView.as_view()),
    ...
]
```

#### 5.2.2 Celery监控

```bash
# 查看Worker状态
celery -A backend inspect active
celery -A backend inspect stats

# 查看任务队列
celery -A backend inspect active_queues

# Flower Web监控（可选）
pip install flower
celery -A backend flower --port=5555
```

### 5.3 备份与恢复

#### 5.3.1 数据库备份

```bash
# Docker Compose环境
docker-compose exec postgres pg_dump -U postgres pdf_backend > backup_$(date +%Y%m%d).sql

# Kubernetes环境
kubectl exec -it postgres-pod -n pdf-backend -- \
  pg_dump -U postgres pdf_backend > backup_$(date +%Y%m%d).sql
```

#### 5.3.2 数据库恢复

```bash
# Docker Compose环境
cat backup_20260120.sql | docker-compose exec -T postgres psql -U postgres pdf_backend

# Kubernetes环境
cat backup_20260120.sql | kubectl exec -i postgres-pod -n pdf-backend -- \
  psql -U postgres pdf_backend
```

#### 5.3.3 媒体文件备份

```bash
# 备份media目录
tar -czf media_backup_$(date +%Y%m%d).tar.gz ./media/

# 恢复media目录
tar -xzf media_backup_20260120.tar.gz
```

---

## 6. 故障排查

### 6.1 常见问题

#### 6.1.1 容器无法启动

```bash
# 查看Pod状态
kubectl describe pod <pod-name> -n pdf-backend

# 查看容器日志
kubectl logs <pod-name> -c django -n pdf-backend

# 常见原因：
# - 镜像拉取失败
# - 环境变量配置错误
# - 依赖服务未就绪
```

#### 6.1.2 数据库连接失败

```bash
# 检查数据库服务
kubectl get svc postgres -n pdf-backend

# 测试数据库连接
kubectl exec -it <api-pod> -n pdf-backend -- \
  python manage.py dbshell

# 常见原因：
# - DATABASE_URL配置错误
# - 数据库密码错误
# - 网络策略阻止连接
```

#### 6.1.3 Celery任务不执行

```bash
# 查看Worker日志
kubectl logs deployment/pdf-backend-worker -n pdf-backend

# 检查RabbitMQ连接
kubectl exec -it <worker-pod> -n pdf-backend -- \
  celery -A backend inspect ping

# 常见原因：
# - CELERY_BROKER_URL配置错误
# - Worker未启动
# - 任务序列化失败
```

#### 6.1.4 文件上传失败

```bash
# 检查PVC挂载
kubectl describe pvc pdf-backend-media -n pdf-backend

# 检查磁盘空间
kubectl exec -it <api-pod> -n pdf-backend -- df -h

# 常见原因：
# - 磁盘空间不足
# - PVC未正确挂载
# - 文件权限问题
```

### 6.2 性能优化

#### 6.2.1 API性能

- 启用数据库连接池
- 使用Redis缓存频繁查询
- 优化数据库查询（select_related, prefetch_related）
- 启用Django Query缓存

#### 6.2.2 Worker性能

- 根据负载动态扩展Worker副本
- 使用任务优先级队列
- 优化MinerU和Step5调用超时
- 监控任务执行时间，识别瓶颈

---

## 7. 安全加固

### 7.1 生产环境配置

```python
# backend/settings/production.py

# 安全配置
DEBUG = False
ALLOWED_HOSTS = [os.environ.get('ALLOWED_HOSTS', '').split(',')]

SECRET_KEY = os.environ.get('SECRET_KEY')
if not SECRET_KEY:
    raise ValueError("SECRET_KEY environment variable must be set")

# HTTPS配置
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# HSTS
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
```

### 7.2 密钥管理

- 使用Kubernetes Secret存储敏感信息
- 定期轮换Secret Key和API密钥
- 使用外部密钥管理服务（如Vault）

### 7.3 网络安全

- 使用NetworkPolicy限制Pod间通信
- 启用Ingress TLS
- 配置防火墙规则

---

**文档结束**
